@{
    ViewData["Title"] = "Gestion de Séances";
    ViewData["Breadcrumb"] = new List<(string Text, string Url)>
{
("Gérer les séances", "/Seance")
};
    Layout = "_DashboardLayout";
}

<div class="container-fluid mt-4 fade-in">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">Gestion des Séances</h2>
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#seanceModal">
            <i class="bi bi-plus-circle me-2"></i>Créer une séance
        </button>
    </div>

    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @TempData["Success"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @TempData["Error"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <div class="card shadow-sm">
        <div class="card-header bg-white py-3">
            <div class="row align-items-center">
                <div class="col">
                    <h5 class="mb-0">Liste des séances</h5>
                </div>
                <div class="col-auto">
                    <div class="input-group">
                        <input type="text" id="searchInput" class="form-control" placeholder="Rechercher...">
                        <button class="btn btn-outline-secondary" type="button">
                            <i class="bi bi-search"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover table-striped" id="seancesTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Cours</th>
                            <th>Groupe / Détails</th>
                            <th>Date et heure</th>
                            <th>Salle</th>
                            <th>Type</th>
                            <th>Durée</th>
                            <th>Statut</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var seance in Model)
                        {
                            <tr>
                                <td>@seance.Id</td>
                                <td>@seance.Cours?.Nom</td>
                                <td>
                                    @if (seance.Groupe != null)
                                    {
                                        @seance.Groupe.Nom
                                    }
                                    else
                                    {
                                        var details = new List<string>();
                                        if (seance.Cycle != null) details.Add(seance.Cycle.NomCycle);
                                        if (seance.Niveau != null) details.Add(seance.Niveau.NomNiveau);
                                        if (seance.Specialite != null) details.Add(seance.Specialite.NomSpecialite);
                                        @string.Join(" - ", details)
                                    }
                                </td>
                                <td>@seance.DateHeureDebut.ToString("dd/MM/yyyy HH:mm") -
                                    @seance.DateHeureFin.ToString("HH:mm")</td>
                                <td>@seance.Salle</td>
                                <td>@seance.Type</td>
                                <td>@seance.Duree h</td>
                                <td>
                                    <span class="badge bg-@(GetStatutColor(seance.Statut))">
                                        @seance.Statut
                                    </span>
                                </td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <button type="button" class="btn btn-sm btn-outline-primary edit-btn"
                                            data-id="@seance.Id" data-cours-id="@seance.CoursId"
                                            data-groupe-id="@(seance.GroupeId?.ToString() ?? "")"
                                            data-cycle-id="@(seance.CycleId?.ToString() ?? "")"
                                            data-niveau-id="@(seance.NiveauId?.ToString() ?? "")"
                                            data-specialite-id="@(seance.SpecialiteId?.ToString() ?? "")"
                                            data-date-debut="@seance.DateHeureDebut.ToString("yyyy-MM-ddTHH:mm")"
                                            data-date-fin="@seance.DateHeureFin.ToString("yyyy-MM-ddTHH:mm")"
                                            data-salle="@seance.Salle" data-type="@seance.Type" data-statut="@seance.Statut"
                                            data-duree="@((int)seance.Duree)">
                                            <i class="bi bi-pencil"></i>
                                        </button>

                                        <!-- Bouton pour la prise d'appel -->
                                        <a href="@Url.Action("PriseAppel", "Assiduite", new { seanceId = seance.Id })"
                                            class="btn btn-sm btn-outline-info" title="Prise d'appel">
                                            <i class="bi bi-clipboard-check"></i>
                                        </a>

                                        <!-- NOUVEAU BOUTON : Gérer le Cahier de Texte -->
                                        <a href="@Url.Action("Index", "CahierDeTexte", new { seanceId = seance.Id })"
                                            class="btn btn-sm btn-outline-secondary" title="Gérer le cahier de texte">
                                            <i class="bi bi-book"></i>
                                        </a>

                                        <a href="@Url.Action("Delete", "Seance", new { id = seance.Id })"
                                            class="btn btn-sm btn-outline-danger delete-btn"
                                            onclick="return confirm('Êtes-vous sûr de vouloir supprimer cette séance ?');">
                                            <i class="bi bi-trash"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal pour créer/éditer une séance -->
<div class="modal fade" id="seanceModal" tabindex="-1" aria-labelledby="seanceModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form asp-action="Save" method="post" id="seanceForm">
                <div class="modal-header">
                    <h5 class="modal-title" id="seanceModalLabel">Créer une séance</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="seanceId" name="Id" value="0">

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="CoursId" class="form-label">Cours <span class="text-danger">*</span></label>
                            <select class="form-select" id="CoursId" name="CoursId" required>
                                <option value="">Sélectionner un cours</option>
                                @foreach (var cours in ViewBag.Cours)
                                {
                                <option value="@cours.Id" data-enseignant-id="@(cours.Enseignant?.Id ?? 0)">
                                    @cours.Nom (@cours.Code) - @(cours.Enseignant?.Prenom ?? "") @(cours.Enseignant?.Nom
                                                                        ?? "")
                                    </option>
                                }
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="GroupeId" class="form-label">Groupe</label>
                            <select class="form-select" id="GroupeId" name="GroupeId">
                                <option value="">Tous les groupes</option>
                                @foreach (var groupe in ViewBag.Groupes)
                                {
                                    <option value="@groupe.Id">@groupe.Nom</option>
                                }
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="Duree" class="form-label">Durée de la séance <span
                                class="text-danger">*</span></label>
                        <select class="form-select" id="Duree" name="Duree" required>
                            <option value="">Sélectionner une durée</option>
                            @foreach (var duree in Enum.GetValues(typeof(PGSA_Licence3.Models.DureeSeance)))
                            {
                                <option value="@((int)duree)">@duree</option>
                            }
                        </select>
                    </div>

                    <!-- Nouveaux champs pour cycle, niveau et spécialité -->
                    <div class="row mb-3" id="cycleNiveauSpecialiteFields" style="display: none;">
                        <div class="col-md-4">
                            <label for="CycleId" class="form-label">Cycle</label>
                            <select class="form-select" id="CycleId" name="CycleId">
                                <option value="">Sélectionner un cycle</option>
                                @foreach (var cycle in ViewBag.Cycles)
                                {
                                    <option value="@cycle.Id">@cycle.NomCycle</option>
                                }
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="NiveauId" class="form-label">Niveau</label>
                            <select class="form-select" id="NiveauId" name="NiveauId">
                                <option value="">Sélectionner un niveau</option>
                                @foreach (var niveau in ViewBag.Niveaux)
                                {
                                    <option value="@niveau.Id">@niveau.NomNiveau</option>
                                }
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="SpecialiteId" class="form-label">Spécialité</label>
                            <select class="form-select" id="SpecialiteId" name="SpecialiteId">
                                <option value="">Sélectionner une spécialité</option>
                                @foreach (var specialite in ViewBag.Specialites)
                                {
                                    <option value="@specialite.Id">@specialite.NomSpecialite</option>
                                }
                            </select>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="DateHeureDebut" class="form-label">Date et heure de début <span
                                    class="text-danger">*</span></label>
                            <input type="datetime-local" class="form-control" id="DateHeureDebut" name="DateHeureDebut"
                                required>
                        </div>
                        <div class="col-md-6">
                            <label for="DateHeureFin" class="form-label">Date et heure de fin <span
                                    class="text-danger">*</span></label>
                            <input type="datetime-local" class="form-control" id="DateHeureFin" name="DateHeureFin"
                                required>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="Salle" class="form-label">Salle <span class="text-danger">*</span></label>
                            <select class="form-select" id="Salle" name="Salle" required>
                                <option value="">Sélectionner une salle</option>
                                @foreach (var salle in ViewBag.Salles)
                                {
                                    <option value="@salle">@salle</option>
                                }
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="Type" class="form-label">Type de séance <span
                                    class="text-danger">*</span></label>
                            <select class="form-select" id="Type" name="Type" required>
                                <option value="">Sélectionner un type</option>
                                <option value="CM">Cours Magistral (CM)</option>
                                <option value="TD">Travaux Dirigés (TD)</option>
                                <option value="TP">Travaux Pratiques (TP)</option>
                                <option value="Evaluation">Evaluation</option>
                            </select>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="Statut" class="form-label">Statut <span class="text-danger">*</span></label>
                        <select class="form-select" id="Statut" name="Statut" required>
                            <option value="Planifiee">Planifiée</option>
                            <option value="EnCours">En cours</option>
                            <option value="Terminee">Terminée</option>
                            <option value="Annulee">Annulée</option>
                        </select>
                    </div>

                    <div id="conflictAlert" class="alert alert-warning d-none" role="alert">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        <span id="conflictMessage"></span>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-primary" id="saveBtn">
                        <i class="bi bi-check-circle me-2"></i>Enregistrer
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Gérer l'affichage des champs Cycle, Niveau et Specialite
            const groupeSelect = document.getElementById('GroupeId');
            const cycleNiveauSpecialiteFields = document.getElementById('cycleNiveauSpecialiteFields');

            function toggleCycleNiveauSpecialiteFields() {
                if (groupeSelect.value === "") {
                    cycleNiveauSpecialiteFields.style.display = 'flex';
                } else {
                    cycleNiveauSpecialiteFields.style.display = 'none';
                }
            }

            groupeSelect.addEventListener('change', toggleCycleNiveauSpecialiteFields);
            toggleCycleNiveauSpecialiteFields(); // Initialiser l'état

            // Mettre à jour automatiquement l'heure de fin en fonction de la durée
            const dureeSelect = document.getElementById('Duree');
            const dateDebutInput = document.getElementById('DateHeureDebut');
            const dateFinInput = document.getElementById('DateHeureFin');

            function updateDateFin() {
                const dateDebut = new Date(dateDebutInput.value);
                const duree = parseInt(dureeSelect.value);

                if (!isNaN(dateDebut.getTime()) && !isNaN(duree)) {
                    const dateFin = new Date(dateDebut.getTime() + duree * 60 * 60 * 1000);
                    dateFinInput.value = dateFin.toISOString().slice(0, 16);
                }
            }

            dureeSelect.addEventListener('change', updateDateFin);
            dateDebutInput.addEventListener('change', updateDateFin);

            // Réinitialiser le formulaire à la fermeture de la modal
            document.getElementById('seanceModal').addEventListener('hidden.bs.modal', function () {
                document.getElementById('seanceForm').reset();
                document.getElementById('seanceId').value = '0';
                document.getElementById('seanceModalLabel').textContent = 'Créer une séance';
                document.getElementById('conflictAlert').classList.add('d-none');
                toggleCycleNiveauSpecialiteFields(); // Réinitialiser l'affichage des champs
            });

            // Gérer l'édition
            document.querySelectorAll('.edit-btn').forEach(button => {
                button.addEventListener('click', function () {
                    const id = this.getAttribute('data-id');
                    const coursId = this.getAttribute('data-cours-id');
                    const groupeId = this.getAttribute('data-groupe-id');
                    const cycleId = this.getAttribute('data-cycle-id');
                    const niveauId = this.getAttribute('data-niveau-id');
                    const specialiteId = this.getAttribute('data-specialite-id');
                    const dateDebut = this.getAttribute('data-date-debut');
                    const dateFin = this.getAttribute('data-date-fin');
                    const salle = this.getAttribute('data-salle');
                    const type = this.getAttribute('data-type');
                    const statut = this.getAttribute('data-statut');
                    const duree = this.getAttribute('data-duree');

                    document.getElementById('seanceId').value = id;
                    document.getElementById('CoursId').value = coursId;
                    document.getElementById('GroupeId').value = groupeId;
                    document.getElementById('CycleId').value = cycleId;
                    document.getElementById('NiveauId').value = niveauId;
                    document.getElementById('SpecialiteId').value = specialiteId;
                    document.getElementById('DateHeureDebut').value = dateDebut;
                    document.getElementById('DateHeureFin').value = dateFin;
                    document.getElementById('Salle').value = salle;
                    document.getElementById('Type').value = type;
                    document.getElementById('Statut').value = statut;
                    document.getElementById('Duree').value = duree;

                    document.getElementById('seanceModalLabel').textContent = 'Modifier une séance';

                    // Appeler la fonction pour afficher/masquer les champs
                    toggleCycleNiveauSpecialiteFields();

                    const modal = new bootstrap.Modal(document.getElementById('seanceModal'));
                    modal.show();
                });
            });

            // Validation des dates et vérification des conflits
            // Supprimé la redéclaration des variables dateDebutInput et dateFinInput
            const salleSelect = document.getElementById('Salle');
            const conflictAlert = document.getElementById('conflictAlert');
            const conflictMessage = document.getElementById('conflictMessage');
            const saveBtn = document.getElementById('saveBtn');

            async function checkConflicts() {
                const dateDebut = new Date(dateDebutInput.value);
                const dateFin = new Date(dateFinInput.value);

                if (dateDebut >= dateFin) {
                    conflictAlert.classList.remove('d-none', 'alert-warning');
                    conflictAlert.classList.add('alert-danger');
                    conflictMessage.textContent = "L'heure de début doit être antérieure à l'heure de fin.";
                    saveBtn.disabled = true;
                    return false;
                }

                // Récupérer les données du formulaire
                const seanceData = {
                    Id: parseInt(document.getElementById('seanceId').value) || 0,
                    CoursId: parseInt(document.getElementById('CoursId').value),
                    GroupeId: document.getElementById('GroupeId').value ? parseInt(document.getElementById('GroupeId').value) : null,
                    CycleId: document.getElementById('CycleId').value ? parseInt(document.getElementById('CycleId').value) : null,
                    NiveauId: document.getElementById('NiveauId').value ? parseInt(document.getElementById('NiveauId').value) : null,
                    SpecialiteId: document.getElementById('SpecialiteId').value ? parseInt(document.getElementById('SpecialiteId').value) : null,
                    DateHeureDebut: dateDebut,
                    DateHeureFin: dateFin,
                    Salle: salleSelect.value,
                    Type: document.getElementById('Type').value,
                    Statut: document.getElementById('Statut').value,
                    Duree: parseInt(document.getElementById('Duree').value)
                };

                // Vérifier les conflits via AJAX
                try {
                    const response = await fetch('/Seance/CheckConflict', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                        },
                        body: JSON.stringify(seanceData)
                    });

                    const result = await response.json();

                    if (result.success && result.conflicts.length > 0) {
                        conflictAlert.classList.remove('d-none', 'alert-danger');
                        conflictAlert.classList.add('alert-warning');
                        conflictMessage.textContent = result.conflicts.join('; ');
                        saveBtn.disabled = false;
                        return true;
                    } else {
                        conflictAlert.classList.add('d-none');
                        saveBtn.disabled = false;
                        return true;
                    }
                } catch (error) {
                    console.error('Erreur lors de la vérification des conflits:', error);
                    conflictAlert.classList.add('d-none');
                    saveBtn.disabled = false;
                    return true;
                }
            }

            dateDebutInput.addEventListener('change', checkConflicts);
            dateFinInput.addEventListener('change', checkConflicts);
            salleSelect.addEventListener('change', checkConflicts);

            // Filtrage du tableau
            const searchInput = document.getElementById('searchInput');
            searchInput.addEventListener('keyup', function () {
                const searchTerm = this.value.toLowerCase();
                const rows = document.querySelectorAll('#seancesTable tbody tr');

                rows.forEach(row => {
                    const text = row.textContent.toLowerCase();
                    row.style.display = text.includes(searchTerm) ? '' : 'none';
                });
            });
        });
    </script>
}
@functions {
    private string GetStatutColor(StatutSeance statut)
    {
        return statut switch
        {
            StatutSeance.Planifiee => "info",
            StatutSeance.EnCours => "primary",
            StatutSeance.Terminee => "success",
            StatutSeance.Annulee => "danger",
            _ => "secondary"
        };
    }
}