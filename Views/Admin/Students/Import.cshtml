@{
    ViewData["Title"] = "Importer des √©tudiants";
    Layout = "_AdminLayout";
}

<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-white py-3">
                    <div class="row align-items-center">
                        <div class="col">
                            <h2 class="h5 mb-0 text-gray-800">@ViewData["Title"]</h2>
                        </div>
                        <div class="col-auto d-flex">
                            <form asp-action="Import" method="post" enctype="multipart/form-data"
                                class="d-flex align-items-center me-2" id="importForm">
                                <div class="me-2">
                                    <input type="file" name="file" accept=".xlsx,.xls"
                                        class="form-control form-control-sm" id="fileInput" />
                                </div>
                                <button type="submit" class="btn btn-primary btn-sm">
                                    <i class="bi bi-upload me-1"></i> Importer
                                </button>
                            </form>

                            <button class="btn btn-success btn-sm" id="submitImportBtn" disabled>
                                <i class="bi bi-save me-1"></i> Enregistrer l'import
                            </button>
                        </div>
                    </div>
                </div>

                <div class="card-body">
                    <div id="import-result" class="mt-3"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- üåü MODAL : Formulaire de modification -->
<div class="modal fade" id="studentModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Modifier les informations de l‚Äô√©tudiant</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <input type="hidden" id="edit_index">
                <form id="studentEditForm">
                    <div class="row g-3">
                        <!-- Champs √©tudiants identiques √† ta version pr√©c√©dente -->
                        <div class="col-md-6">
                            <label class="form-label">Matricule</label>
                            <input type="text" class="form-control" id="edit_matricule" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">T√©l√©phone</label>
                            <input type="text" class="form-control" id="edit_telephone" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Nom</label>
                            <input type="text" class="form-control" id="edit_nom" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Pr√©nom</label>
                            <input type="text" class="form-control" id="edit_prenom" />
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Niveau</label>
                            <input type="text" class="form-control" id="edit_niveau" />
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Fili√®re</label>
                            <input type="text" class="form-control" id="edit_filiere" />
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Sp√©cialit√©</label>
                            <input type="text" class="form-control" id="edit_specialite" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Email</label>
                            <input type="text" class="form-control" id="edit_email" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Email institutionnel</label>
                            <input type="text" class="form-control" id="edit_emailInstitutionnel" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Username</label>
                            <input type="text" class="form-control" id="edit_username" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Date d'inscription</label>
                            <input type="date" class="form-control" id="edit_dateInscription" />
                        </div>
                    </div>
                </form>
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                <button class="btn btn-primary" id="saveEditBtn">Enregistrer</button>
            </div>
        </div>
    </div>
</div>
<!-- üåü MODAL DE RAPPORT -->
<div class="modal fade" id="reportModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Rapport de l'import</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="reportModalBody">
                <!-- Le contenu sera inject√© par JS -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
    const form = document.getElementById('importForm');
    const resultDiv = document.getElementById('import-result');
    const saveBtn = document.getElementById('submitImportBtn');

    let importedStudents = []; // stockage complet

    // ================================
    //        IMPORT EXCEL
    // ================================
    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        resultDiv.innerHTML = `<p class="text-center text-muted">Importation...</p>`;
        const formData = new FormData(form);

        const response = await fetch(form.action, { method: "POST", body: formData });
        const data = await response.json();

        importedStudents = data;
        renderTable();

        // Activer le bouton d'enregistrement
        saveBtn.disabled = importedStudents.length === 0;
    });

    // ================================
    //        AFFICHAGE TABLEAU
    // ================================
    function renderTable() {
        let table = `
        <div class="table-responsive">
            <table class="table table-hover table-bordered" id="studentsTable">
                <thead class="table-dark">
                    <tr>
                        <th>Matricule</th>
                        <th>Nom</th>
                        <th>Pr√©nom</th>
                        <th>Username</th>
                        <th>Email</th>
                        <th>Fili√®re</th>
                        <th>Niveau</th>
                    </tr>
                </thead>
                <tbody>
        `;

        importedStudents.forEach((s, i) => {
            table += `
            <tr class="student-row" data-index="${i}" style="cursor:pointer;">
                <td>${s.matricule}</td>
                <td>${s.nom}</td>
                <td>${s.prenom}</td>
                <td>${s.username}</td>
                <td>${s.email}</td>
                <td>${s.filiere}</td>
                <td>${s.niveau}</td>
            </tr>`;
        });

        table += `
                </tbody>
            </table>
        </div>`;

        resultDiv.innerHTML = table;

        document.querySelectorAll(".student-row").forEach(row => {
            row.addEventListener("click", () => {
                const index = row.dataset.index;
                openStudentModal(index);
            });
        });
    }

    // ================================
    //      OUVERTURE DU MODAL
    // ================================
    function openStudentModal(index) {
        const st = importedStudents[index];
        document.getElementById("edit_index").value = index;

        document.getElementById("edit_matricule").value = st.matricule;
        document.getElementById("edit_nom").value = st.nom;
        document.getElementById("edit_prenom").value = st.prenom;
        document.getElementById("edit_telephone").value = st.telephone ?? "";
        document.getElementById("edit_niveau").value = st.niveau;
        document.getElementById("edit_filiere").value = st.filiere;
        document.getElementById("edit_specialite").value = st.specialite ?? "";
        document.getElementById("edit_email").value = st.email;
        document.getElementById("edit_emailInstitutionnel").value = st.emailInstitutionnel ?? "";
        document.getElementById("edit_username").value = st.username;

        if (st.dateInscription)
            document.getElementById("edit_dateInscription").value = st.dateInscription.split("T")[0];

        new bootstrap.Modal(document.getElementById("studentModal")).show();
    }

    // ================================
    //         ENREGISTRER EDITION
    // ================================
    document.getElementById("saveEditBtn").addEventListener("click", () => {
        const index = document.getElementById("edit_index").value;

        importedStudents[index] = {
            ...importedStudents[index],
            matricule: document.getElementById("edit_matricule").value,
            nom: document.getElementById("edit_nom").value,
            prenom: document.getElementById("edit_prenom").value,
            telephone: document.getElementById("edit_telephone").value,
            niveau: document.getElementById("edit_niveau").value,
            filiere: document.getElementById("edit_filiere").value,
            specialite: document.getElementById("edit_specialite").value,
            email: document.getElementById("edit_email").value,
            emailInstitutionnel: document.getElementById("edit_emailInstitutionnel").value,
            username: document.getElementById("edit_username").value,
            dateInscription: document.getElementById("edit_dateInscription").value
        };

        renderTable();
        bootstrap.Modal.getInstance(document.getElementById("studentModal")).hide();
    });

    // ================================
    //      ENREGISTRER EN BD avec gestion conflits
    // ================================
saveBtn.addEventListener("click", async () => {
    saveBtn.disabled = true;
    saveBtn.innerHTML = "Enregistrement...";

    try {
        const requestPayload = {
            students: importedStudents,   // note le nom "students" en minuscule pour correspondre au JSON
            overwriteExisting: false       // ou true si tu veux √©craser les doublons
        };

        const response = await fetch("/Students/Save", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(requestPayload)
        });

        const res = await response.json();
        const reportBody = document.getElementById("reportModalBody");

        let html = `<p>${res.message}</p>`;

        if (res.conflicts && res.conflicts.length > 0) {
            html += `<h6>Conflits d√©tect√©s :</h6>`;
            html += `<ul>`;
            res.conflicts.forEach(c => {
                html += `<li>Matricule: ${c.matricule}, Username: ${c.username}, Email: ${c.email} ‚Üí ${c.problem}</li>`;
            });
            html += `</ul>`;
        }

        reportBody.innerHTML = html;
        new bootstrap.Modal(document.getElementById("reportModal")).show();

    } catch (error) {
        console.error(error);
        const reportBody = document.getElementById("reportModalBody");
        reportBody.innerHTML = "<p class='text-danger'>Une erreur est survenue lors de l'enregistrement.</p>";
        new bootstrap.Modal(document.getElementById("reportModal")).show();
    }

    saveBtn.disabled = false;
    saveBtn.innerHTML = '<i class="bi bi-save me-1"></i> Enregistrer l\'import';
});

</script>
}