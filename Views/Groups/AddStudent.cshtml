@model PGSA_Licence3.Models.Groupe
@{
    ViewData["Title"] = $"Ajouter des étudiants - {Model.Nom}";
    ViewData["Breadcrumb"] = new List<(string Text, string Url)>
    {
        ("Gestion des Groupes", "/Groups"),
        (Model.Nom, $"/Groups/Details/{Model.Id}"),
        ("Ajouter étudiants", $"/Groups/AddStudent/{Model.Id}")
    };
    Layout = "_DashboardLayout";
}

<div class="container-fluid mt-4 fade-in">
    <div class="row">
        <div class="col-12">
            <!-- Header avec informations du groupe -->
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-white py-3 border-0 d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 50px; height: 50px;">
                            <i class="bi bi-collection fs-4"></i>
                        </div>
                        <div>
                            <h2 class="h4 mb-0 text-gray-800">@Model.Nom</h2>
                            <p class="text-muted mb-0 mt-1">@Model.Niveau - @Model.Filiere • @(Model.Etudiants?.Count ?? 0) étudiant(s)</p>
                        </div>
                    </div>

                    <a href="@Url.Action("Details", "Groups", new { id = Model.Id })" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left me-1"></i>Retour aux détails
                    </a>
                </div>
            </div>

            <div class="row">
                <!-- Étudiants disponibles -->
                <div class="col-lg-8">
                    <div class="card shadow-sm border-0">
                        <div class="card-header bg-white py-3 border-0">
                            <h5 class="mb-0">
                                <i class="bi bi-people me-2 text-primary"></i>Étudiants disponibles
                                <span class="badge bg-primary ms-2" id="availableCount">0</span>
                            </h5>
                        </div>
                        <div class="card-body">
                            <form method="post" id="addStudentsForm">
                                @Html.AntiForgeryToken()

                                <!-- Filtres -->
                                <div class="row g-3 mb-3">
                                    <div class="col-md-6">
                                        <input type="text" class="form-control" id="searchStudent" placeholder="Rechercher un étudiant...">
                                    </div>
                                    <div class="col-md-6">
                                        <select class="form-select" id="sortStudents">
                                            <option value="name">Trier par nom</option>
                                            <option value="firstname">Trier par prénom</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- Sélection des étudiants -->
                                <div id="studentsList" class="mb-3" style="max-height: 400px; overflow-y: auto;">
                                    <div class="text-center py-4">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Chargement...</span>
                                        </div>
                                        <p class="text-muted mt-2">Chargement des étudiants disponibles...</p>
                                    </div>
                                </div>

                                <!-- Actions -->
                                <div class="d-flex justify-content-between align-items-center pt-3 border-top">
                                    <div>
                                        <span class="text-muted" id="selectionInfo">0 étudiant(s) sélectionné(s)</span>
                                    </div>
                                    <div>
                                        <button type="button" class="btn btn-outline-secondary me-2" onclick="clearSelection()">
                                            <i class="bi bi-x-circle me-1"></i>Vider
                                        </button>
                                        <button type="submit" class="btn btn-success" id="addBtn" disabled>
                                            <i class="bi bi-person-plus me-1"></i>Ajouter au groupe
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Étudiants actuels du groupe -->
                <div class="col-lg-4">
                    <div class="card shadow-sm border-0">
                        <div class="card-header bg-white py-3 border-0">
                            <h5 class="mb-0">
                                <i class="bi bi-check-circle me-2 text-success"></i>Étudiants du groupe
                                <span class="badge bg-success ms-2">@(Model.Etudiants?.Count ?? 0)</span>
                            </h5>
                        </div>
                        <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                            @if (Model.Etudiants == null || !Model.Etudiants.Any())
                            {
                                <div class="text-center py-4">
                                    <i class="bi bi-people display-4 text-muted mb-3"></i>
                                    <p class="text-muted">Aucun étudiant dans ce groupe</p>
                                </div>
                            }
                            else
                            {
                                <div class="list-group list-group-flush">
                                    @foreach (var etudiant in Model.Etudiants.OrderBy(e => e.Nom).ThenBy(e => e.Prenom))
                                    {
                                        <div class="list-group-item px-0 d-flex justify-content-between align-items-center">
                                            <div class="d-flex align-items-center">
                                                <div class="bg-success text-white rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 35px; height: 35px;">
                                                    <i class="bi bi-person-check"></i>
                                                </div>
                                                <div>
                                                    <strong>@etudiant.Nom</strong>
                                                    <br><small class="text-muted">@etudiant.Prenom</small>
                                                </div>
                                            </div>
                                            <button type="button" class="btn btn-sm btn-outline-danger"
                                                    onclick="confirmRemove(@etudiant.Id, '@etudiant.Nom @etudiant.Prenom')">
                                                <i class="bi bi-person-dash"></i>
                                            </button>
                                        </div>
                                    }
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de confirmation de retrait -->
<div class="modal fade" id="removeModal" tabindex="-1" aria-labelledby="removeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-warning text-dark border-0">
                <h5 class="modal-title" id="removeModalLabel">
                    <i class="bi bi-person-dash me-2"></i>Confirmer le retrait
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Êtes-vous sûr de vouloir retirer <strong id="removeStudentName"></strong> du groupe ?</p>
                <div class="alert alert-info">
                    <i class="bi bi-info-circle me-2"></i>
                    L'étudiant pourra être ajouté à un autre groupe par la suite.
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <form id="removeForm" method="post" style="display: inline;">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="groupeId" value="@Model.Id" />
                    <input type="hidden" name="etudiantId" />
                    <button type="submit" class="btn btn-warning">
                        <i class="bi bi-person-dash me-1"></i>Retirer
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log("Page ajout étudiants chargée !");

            // Animation des cartes
            const cards = document.querySelectorAll('.card');
            cards.forEach((card, index) => {
                setTimeout(() => {
                    card.classList.add('fade-in');
                }, index * 100);
            });

            // Charger les étudiants disponibles
            loadAvailableStudents();

            // Gestionnaires d'événements
            document.getElementById('searchStudent').addEventListener('input', filterStudents);
            document.getElementById('sortStudents').addEventListener('change', sortStudents);
        });

        let allStudents = [];
        let selectedStudents = new Set();

        async function loadAvailableStudents() {
            try {
                const response = await fetch('/GroupStudents/GetAvailableStudents');
                const students = await response.json();

                allStudents = students;
                renderStudentsList(students);
                document.getElementById('availableCount').textContent = students.length;

            } catch (error) {
                console.error('Erreur lors du chargement des étudiants:', error);
                document.getElementById('studentsList').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-circle me-2"></i>
                        Erreur lors du chargement des étudiants disponibles.
                    </div>
                `;
            }
        }

        function renderStudentsList(students) {
            const container = document.getElementById('studentsList');

            if (students.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4">
                        <i class="bi bi-people display-4 text-muted mb-3"></i>
                        <h5 class="text-muted">Aucun étudiant disponible</h5>
                        <p class="text-muted">Tous les étudiants sont déjà dans des groupes.</p>
                    </div>
                `;
                return;
            }

            const studentsHtml = students.map(student => `
                <div class="student-item form-check p-3 border rounded mb-2" data-student-id="${student.id}" data-name="${student.text.toLowerCase()}">
                    <input class="form-check-input student-checkbox" type="checkbox" name="selectedStudentIds" value="${student.id}" id="student_${student.id}">
                    <label class="form-check-label w-100" for="student_${student.id}">
                        <div class="d-flex align-items-center">
                            <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
                                <i class="bi bi-person"></i>
                            </div>
                            <div>
                                <strong>${student.text}</strong>
                            </div>
                        </div>
                    </label>
                </div>
            `).join('');

            container.innerHTML = studentsHtml;

            // Attacher les gestionnaires d'événements
            document.querySelectorAll('.student-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', updateSelection);
            });
        }

        function updateSelection() {
            selectedStudents.clear();
            document.querySelectorAll('.student-checkbox:checked').forEach(checkbox => {
                selectedStudents.add(checkbox.value);
            });

            const count = selectedStudents.size;
            document.getElementById('selectionInfo').textContent = `${count} étudiant(s) sélectionné(s)`;
            document.getElementById('addBtn').disabled = count === 0;

            // Mettre à jour l'apparence des éléments sélectionnés
            document.querySelectorAll('.student-item').forEach(item => {
                const checkbox = item.querySelector('.student-checkbox');
                if (checkbox.checked) {
                    item.classList.add('border-primary', 'bg-light');
                } else {
                    item.classList.remove('border-primary', 'bg-light');
                }
            });
        }

        function filterStudents() {
            const searchTerm = document.getElementById('searchStudent').value.toLowerCase();
            const filteredStudents = allStudents.filter(student =>
                student.text.toLowerCase().includes(searchTerm)
            );
            renderStudentsList(filteredStudents);
        }

        function sortStudents() {
            const sortBy = document.getElementById('sortStudents').value;
            let sortedStudents = [...allStudents];

            if (sortBy === 'firstname') {
                sortedStudents.sort((a, b) => {
                    const aParts = a.text.split(' ');
                    const bParts = b.text.split(' ');
                    const aFirst = aParts.length > 1 ? aParts[1] : aParts[0];
                    const bFirst = bParts.length > 1 ? bParts[1] : bParts[0];
                    return aFirst.localeCompare(bFirst);
                });
            } else {
                sortedStudents.sort((a, b) => a.text.localeCompare(b.text));
            }

            renderStudentsList(sortedStudents);
        }

        function clearSelection() {
            document.querySelectorAll('.student-checkbox:checked').forEach(checkbox => {
                checkbox.checked = false;
            });
            updateSelection();
        }

        function confirmRemove(etudiantId, studentName) {
            document.getElementById('removeStudentName').textContent = studentName;
            const form = document.getElementById('removeForm');
            form.action = `/GroupStudents/RemoveStudent`;
            
            // S'assurer que les champs cachés existent
            let groupeIdInput = form.querySelector('input[name="groupeId"]');
            if (!groupeIdInput) {
                groupeIdInput = document.createElement('input');
                groupeIdInput.type = 'hidden';
                groupeIdInput.name = 'groupeId';
                form.appendChild(groupeIdInput);
            }
            groupeIdInput.value = @Model.Id;
            
            let etudiantIdInput = form.querySelector('input[name="etudiantId"]');
            if (!etudiantIdInput) {
                etudiantIdInput = document.createElement('input');
                etudiantIdInput.type = 'hidden';
                etudiantIdInput.name = 'etudiantId';
                form.appendChild(etudiantIdInput);
            }
            etudiantIdInput.value = etudiantId;
            
            new bootstrap.Modal(document.getElementById('removeModal')).show();
        }
    </script>

    <style>
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }

        @@keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            border-radius: 0.75rem;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        }

        .card-header {
            border-radius: 0.75rem 0.75rem 0 0 !important;
        }

        .student-item {
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .student-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .student-item.bg-light {
            background-color: rgba(44, 123, 229, 0.05) !important;
        }

        .list-group-item {
            border: none;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .list-group-item:last-child {
            border-bottom: none;
        }

        .btn-success {
            background: var(--success);
            border-color: var(--success);
        }

        .btn-success:hover {
            background: #00b97e;
            border-color: #00b97e;
        }

        .border-primary {
            border-color: var(--primary) !important;
        }
    </style>
}